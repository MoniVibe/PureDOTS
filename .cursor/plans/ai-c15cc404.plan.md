<!-- c15cc404-aced-4aaa-82fe-ca1acd737129 42afb0b4-77d1-449f-a1ce-ea7738184ea5 -->
# Deterministic Villager Work Loop Plan

## Scope

Implement a deterministic WorkOffer-driven villager job loop atop the existing PureDOTS AOSoA spine, integrating need decay, shift gating, spatial layers, and perf/test harnesses. User will run Unity tests; we focus on runtime systems, data, and ScenarioRunner assets.

## Tasks

1. **Offer & Claim Infrastructure**  

- Add `WorkOffer`, `WorkClaim`, `OfferNonce`, `WorkOfferBuildSystem`, `WorkAssignmentSystem`.  
- Emit offers from resource/storehouse/jobsite authoring or systems; enforce slot/taken invariants and deterministic seeds.  
- Extend `JobDefinitionCatalog` with Gather/Haul/Build/Rest definitions and expose job IDs to systems.

2. **Scheduler Integration**  

- Extend `VillagerJobPrioritySchedulerSystem` to read `WorkOffer` buffers, NeedsHot, shift mask, ETA, and issue `WorkClaim`.  
- Add ETA sampling using `SpatialLayerConfig` multipliers and layer masks.  
- Ensure tie-breaking uses deterministic seeds.

3. **Needs, Shifts, and Hot Components**  

- Create `VillagerNeedsHot` (AOSoA hot data) and `NeedDecaySystem` (Burst, FixedStep) using `VillagerNeedCurve`.  
- Add shift gating (bitset/mask) and integrate with scheduler utility.

4. **Spatial Layer Masking & ETA Utility**  

- Augment offers/villagers with `LayerMask`.  
- Implement path ETA estimation via existing spatial helpers and feed into utility scoring.

5. **Job Execution Loop**  

- Update villager job state machine to handle Idle→Navigate→Act→Deliver phases based on `WorkClaim`.  
- Integrate navigation, act timing, delivery, reward/storehouse interactions (`StorehouseApi.TryDeposit/Withdraw`).

6. **Determinism & Rewind Safeguards**  

- Audit systems to run in FixedStep; replace any `Time.realtimeSinceStartup` uses.  
- Add determinism tests: 30/60/120 FPS parity + rewind/resim equality.  
- Seed handling for offers/villagers; tie-breakers use `Random(seed ^ tick)`.

7. **AOSoA Hot/Cold Split**  

- Move cold data (names, biography, skills) to companion components/buffers.  
- Keep scheduler-facing data (NeedsHot, JobState, Navigation) contiguous for cache-friendly access.  
- Update authoring/bakers accordingly.

8. **ScenarioRunner Perf Harness**  

- Add `villagers_jobs_1k.json` scenario with 1k agents and counters (Schedule ms, Offer count, Claims).  
- Implement runtime asserts for budget (Fixed tick <=16.6ms, Offer/Claim caps, snapshot bounds).  
- Hook counters into telemetry/logging for CI visibility.

9. **Conservation & Telemetry Tests**  

- Implement `StorehouseApi` helpers and PlayMode tests verifying gathered == deposited (minus consumption).  
- Emit telemetry metrics for gather/deliver/consume/build.

10. **Presentation Bridge (Optional Graybox)**  

- Emit `PlayEffectRequest("FX.Job.Act")` when `VillagerJobState.Phase==Act` via presentation ECB; keep optional and swappable.  
- Add a headless test to confirm sim runs with/without bridge enabled.

11. **Threading & Scheduling Polish**  

- Convert remaining main-thread foreach loops in job/offer systems to `IJobEntity` with `ScheduleParallel()`.  
- Ensure ECB writers and lookups follow chunk-friendly access patterns.

## Deliverables

- New/updated runtime systems and components under `Packages/com.moni.puredots/Runtime/...`.  
- ScenarioRunner config `villagers_jobs_1k.json`.  
- PlayMode/Determinism tests.  
- Optional minimal presentation effect hook.  
- Documentation updates (offer flow, harness usage) if needed.

### To-dos

- [ ] Explore space4x/godgame/puredots AI hooks
- [ ] Assess puredots AI readiness and plan fixes
- [ ] Extend AISystemGroup sensors/archetypes in package
- [ ] Wire Godgame villagers into shared AI pipeline
- [ ] Refactor Space4X vessels to consume AI commands
- [ ] Add tests/docs for new AI integrations
- [ ] Add WorkOffer/WorkClaim + build/assignment systems
- [ ] Extend scheduler for offers + needs/shift/ETA
- [ ] Need decay + VillagerNeedsHot
- [ ] Layer masks + ETA-aware utility
- [ ] Update job state machine for claims→act→deliver
- [ ] FixedStep parity + rewind tests
- [ ] Separate hot/cold villager data
- [ ] Add villagers_jobs_1k scenario + counters
- [ ] Storehouse API + conservation tests
- [ ] Optional FX + headless test
- [ ] Parallelize remaining loops